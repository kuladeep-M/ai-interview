<div class="interview-page-container">

  <aside class="sidebar-panel" *ngIf="showSidebar">
    <button class="icon-btn toggle-sidebar-btn" (click)="toggleSidebar()"
      style="position: absolute; top: 18px; left: 18px; background: none; border: none; cursor: pointer;">
      <span *ngIf="showSidebar">
        <!-- Eye-off icon -->
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
          <circle cx="11" cy="11" r="10" fill="#eee" />
          <path d="M4 11c2.5-4 7.5-4 10 0" stroke="#5d5cff" stroke-width="2" fill="none" />
          <line x1="6" y1="16" x2="16" y2="6" stroke="#d40754" stroke-width="2" />
        </svg>
      </span>
      <span *ngIf="!showSidebar">
        <!-- Eye icon -->
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
          <circle cx="11" cy="11" r="10" fill="#eee" />
          <path d="M4 11c2.5-4 7.5-4 10 0" stroke="#5d5cff" stroke-width="2" fill="none" />
          <circle cx="11" cy="11" r="3" fill="#5d5cff" />
        </svg>
      </span>
    </button>
    <div class="header">
      <span class="logo">ü§ñ AI Interview</span>
      <span class="sub-text">Voice Assistant</span>
    </div>
    <div class="section-block settings-section">
      <h3>Settings</h3>
      <div class="setting-item">
        <label for="speech-rec">Speech Recognition</label>
        <input type="checkbox" id="speech-rec" checked>
      </div>
      <div class="setting-item">
        <label for="show-ai-text">Show AI Speaking Text</label>
        <input type="checkbox" id="show-ai-text" [checked]="showAISpeakingText()"
          (change)="toggleShowAISpeakingText($event)">
      </div>
      <div class="setting-item">
        <label for="show-user-text">Show User Speaking Text</label>
        <input type="checkbox" id="show-user-text" [checked]="showUserSpeakingText()"
          (change)="toggleShowUserSpeakingText($event)">
      </div>
      <div class="setting-item">
        <label for="helper-tools">Helper Tools</label>
        <input type="checkbox" id="helper-tools">
      </div>
    </div>
    
  </aside>

  <main class="main-content-panel">
    <header class="main-header">
      <h2>Technical Interview</h2>
      <p>Senior Frontend Developer Position</p>
      <span class="time-limit">‚è± {{ formattedTimer }}</span>
      <button class="btn btn-end-interview" (click)="onEndInterview()">üõë End Interview</button>
    </header>

    <section class="ai-question-block">
      <div class="ai-avatar">ü§ñ</div>
      <div class="ai-speech-bubble">
        <p class="ai-status">
          <span style="color: #5d5cff; font-weight: 600;">AI Interviewer</span>
          <span *ngIf="aiSpeaking() && !showAISpeakingText() && !isRecordingActive" class="ai-top-speaking-indicator"
            style="margin-left: 12px;">
            <svg width="22" height="22" viewBox="0 0 22 22" style="vertical-align: middle; margin-right: 4px;">
              <circle cx="11" cy="11" r="10" fill="#388e3c" />
              <path d="M11 6a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2v2" stroke="#fff" stroke-width="2" stroke-linecap="round"
                fill="none" />
              <animateTransform attributeName="transform" type="scale" values="1;1.2;1" dur="1s"
                repeatCount="indefinite" />
            </svg>
            <span style="color: #388e3c; font-weight: 600; font-size: 1.1em;">Speaking...</span>
          </span>
        </p>
        <ng-container>
          <div class="chat-window minimal-chat" #chatWindow>
            @for (chat of conversationHistory.slice(-4); track chat; let i = $index) {
            <div *ngIf="chat.speaker === 'ai' ? showAISpeakingText() : showUserSpeakingText()"
              class="chat-bubble minimal-bubble" [ngClass]="chat.speaker">
              <div class="avatar minimal-avatar">
                <ng-container *ngIf="chat.speaker === 'ai'; else userKAvatar">
                  <!-- Robot/Computer SVG Avatar for AI -->
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="6" width="16" height="12" rx="3" fill="#00C9A7" stroke="#222" stroke-width="1.5" />
                    <rect x="8" y="10" width="8" height="4" rx="2" fill="#fff" />
                    <circle cx="7" cy="9" r="1" fill="#222" />
                    <circle cx="17" cy="9" r="1" fill="#222" />
                    <rect x="10" y="18" width="4" height="2" rx="1" fill="#00C9A7" stroke="#222" stroke-width="1" />
                  </svg>
                </ng-container>
                <ng-template #userKAvatar>
                  <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                      <filter id="kShadow" x="0" y="0" width="32" height="32">
                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#888" flood-opacity="0.25" />
                      </filter>
                    </defs>
                    <circle cx="20" cy="20" r="16" fill="#6C63FF" filter="url(#kShadow)" />
                    <text x="20" y="24" text-anchor="middle" font-size="18" fill="#fff" font-family="Arial, sans-serif"
                      dominant-baseline="middle">K</text>
                  </svg>
                </ng-template>
              </div>
              <div class="bubble-content minimal-content">
                <ng-container *ngIf="chat.speaker === 'ai'; else userText">
                  <div class="ai-message-bubble">
                    <ng-container *ngIf="getAiMessageParts(chat.text) as parts">
                      <div *ngIf="parts.question" class="ai-question" [innerHTML]="parts.question"></div>
                      <div *ngIf="parts.rest" class="ai-rest" [innerHTML]="parts.rest"></div>
                      <pre *ngIf="parts.code" class="ai-code-block"><code [innerHTML]="parts.code"></code></pre>
                    </ng-container>
                  </div>
                </ng-container>
                <ng-template #userText>
                  <span class="chat-text-user minimal-text">{{ chat.text }}</span>
                </ng-template>
                <span *ngIf="chat.speaker === 'ai' && aiSpeaking() && !isRecordingActive" class="ai-speaking-indicator">
                  <span class="ai-pulse-dot"></span>
                  <span class="ai-speaking-label">Speaking...</span>
                </span>
              </div>
            </div>
            }
            <ng-container *ngIf="liveTranscript()">
              <div class="avatar minimal-avatar">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="16" cy="20" r="14" fill="#6C63FF" />
                  <text x="16" y="22" text-anchor="middle" font-size="16" fill="#fff" font-family="Arial, sans-serif"
                    dominant-baseline="middle">K</text>
                </svg>
              </div>
              <div class="chat-bubble user live minimal-bubble"
                (ngAfterViewInit)="chatWindow.scrollTop = chatWindow.scrollHeight"
                (ngOnChanges)="chatWindow.scrollTop = chatWindow.scrollHeight">

                <div class="bubble-content minimal-content">
                  <span class="chat-text minimal-text">{{ liveTranscript() }}</span>
                </div>
              </div>
            </ng-container>

          </div>
        </ng-container>
      </div>
    </section>

    <section class="user-response-section">

      <div class="response-editor-container" *ngIf="activeInputMode() === 'text' || activeInputMode() === 'code'">
        <h3>Your Response</h3>
        <div *ngIf="activeInputMode() === 'code'">
          <div class="editor-toolbar" style="margin-bottom: 8px;">
            <label for="language-select" style="margin-right: 8px; font-weight: 500;">Language:</label>
            <select id="language-select" [(ngModel)]="selectedLanguage" (change)="onLanguageChange($event)"
              style="padding: 4px 8px; border-radius: 4px;">
              <option value="javascript">JavaScript</option>
              <option value="typescript">TypeScript</option>
              <option value="csharp">C#</option>
            </select>
          </div>
          <div class="code-editor-wrapper">
            <ngx-monaco-editor [options]="codeEditorOptions"
              [model]="{ value: codeEditorContent, language: selectedLanguage }"
              (modelChange)="onCodeEditorChange($event)"
              style="height:300px;width:100%;border-radius:8px;box-shadow:0 2px 8px rgba(44,62,80,0.10);">
            </ngx-monaco-editor>
          </div>
        </div>
        <textarea *ngIf="activeInputMode() === 'text'" class="response-editor-placeholder"
          placeholder="Type your text response here..." [(ngModel)]="userTranscriptValue"
          (keydown)="onTextAreaKeydown($event)"></textarea>
      </div>


      <div class="response-controls">

        <div class="control-group left">
          <button class="btn btn-skip" (click)="onPassSkip()">
            <span class="icon-skip">
              <!-- Double forward arrow icon -->
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                <circle cx="16" cy="16" r="14" fill="#90CAF9" />
                <polygon points="11,11 17,16 11,21" fill="#fff" />
                <polygon points="17,11 23,16 17,21" fill="#fff" />
              </svg>
            </span>
            <span class="skip-label">Pass / Skip</span>
          </button>
        </div>
        <div class="control-group center vertical-controls">
          <!-- Mic Button -->
          <button class="btn btn-style btn-mic" (click)="toggleRecording()"
            [class.active]="isRecordingActive && activeInputMode() === 'speech'">
            <span class="icon-mic">
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                <circle cx="16" cy="16" r="16" fill="#EC407A" />
                <rect x="13" y="8" width="6" height="12" rx="3" fill="#fff" />
                <rect x="15" y="20" width="2" height="4" rx="1" fill="#fff" />
                <rect x="12" y="24" width="8" height="2" rx="1" fill="#fff" />
              </svg>
            </span>
            <span *ngIf="activeInputMode() === 'speech'" class="icon-tooltip">
              {{ isRecordingActive ? 'Mic is On' : 'Mic is Off' }}
            </span>
          </button>

          <!-- Keyboard Button -->
          <button class="btn-style btn-text-mode" (click)="setInputMode('text')"
            [class.active]="activeInputMode() === 'text'">
            <span class="icon-text">
              <!-- Keyboard icon without border, matching mic -->
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                <circle cx="16" cy="16" r="16" fill="#7E57C2" />
                <rect x="6" y="13" width="20" height="7" rx="2" fill="#fff" />
                <rect x="10" y="15" width="2" height="2" rx="1" fill="#7E57C2" />
                <rect x="14" y="15" width="2" height="2" rx="1" fill="#7E57C2" />
                <rect x="18" y="15" width="2" height="2" rx="1" fill="#7E57C2" />
                <rect x="22" y="15" width="2" height="2" rx="1" fill="#7E57C2" />
                <rect x="12" y="18" width="8" height="2" rx="1" fill="#7E57C2" />
              </svg>
            </span>
            <span class="icon-tooltip">
              {{ activeInputMode() === 'text' ? 'Text Mode On' : 'Text Mode Off' }}
            </span>
          </button>

          <!-- Code Button -->
          <button class="btn-style btn-code" (click)="setInputMode('code')"
            [class.active]="activeInputMode() === 'code'">
            <span class="icon-code">
              <!-- Perfectly centered code icon: arrow and dash -->
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                <circle cx="16" cy="16" r="16" fill="#20b2c2" />
                <polyline points="12,15 16,18 12,21" stroke="#fff" stroke-width="2.5" stroke-linecap="round"
                  stroke-linejoin="round" fill="none" />
                <rect x="18" y="17" width="7" height="2.5" rx="1" fill="#fff" />
              </svg>
            </span>
            <span class="icon-tooltip">
              {{ activeInputMode() === 'code' ? 'Code Mode On' : 'Code Mode Off' }}
            </span>
          </button>
        </div>

        <div style="width: 204px;" class="control-group right">
          <button class="btn btn-submit" *ngIf="activeInputMode() !== 'speech'" (click)="submitAnswer()">
            <span class="icon-submit">
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                <rect x="2" y="8" width="28" height="16" rx="8" fill="#5d5cff" />
                <path d="M10 16h12M18 12l4 4-4 4" stroke="#fff" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </span>
            <span class="submit-label">Submit Answer</span>
          </button>
        </div>
      </div>
    </section>
  </main>
</div>